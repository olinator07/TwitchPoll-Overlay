<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TwitchPoll Overlay</title>
  <style>
    :root{
      /* THEME */
      --bg: rgba(19,18,24,.55);
      --card: rgba(26,24,33,.65);
      --text: #fff;
      --muted: #c7c7d4;
      --accent: #c6b9ff;             /* Titel-Farbe */
      --bar-fill: #8b5cf6;           /* Lila */
      --bar-fill-2: #a78bfa;         /* Verlauf 2 */
      --bar-bg: rgba(255,255,255,.14);
      --glow: 0 10px 30px rgba(139,92,246,.35);
      --width: 380px;
      --radius: 14px;
      --blur: 8px;
    }

    html,body{margin:0;padding:0;background:transparent;color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;}

    .overlay{position:fixed;top:24px;right:24px;width:var(--width);z-index:99999}
    .left{right:auto;left:24px}
    .scale{transform-origin: top right}

    .card{
      backdrop-filter: blur(var(--blur));
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px 14px 12px;
      box-shadow: var(--glow);
      border: 1px solid rgba(255,255,255,.06);
    }

    .title{
      display:flex;align-items:center;gap:8px;
      font-weight:800;letter-spacing:.02em;
      color:var(--accent);font-size:16px;margin:0 0 10px;
      text-transform:uppercase;
    }
    .title .dot{
      width:8px;height:8px;border-radius:50%;background:var(--bar-fill);
      box-shadow:0 0 12px var(--bar-fill);
    }

    /* Zeilen */
    .row{margin:10px 0}
    .label{display:flex;justify-content:space-between;gap:10px;
      font-weight:650;font-size:14px;color:#f5f5ff}
    .label .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;opacity:.95}
    .label .count{opacity:.9}

    /* Balken */
    .bar{position:relative;height:28px;background:var(--bar-bg);border-radius:10px;overflow:hidden}
    .fill{
      position:absolute;inset:0 auto 0 0;height:100%;width:0%;
      background: linear-gradient(90deg,var(--bar-fill),var(--bar-fill-2));
      transition: width 350ms ease;
    }
    .pct{position:absolute;right:10px;top:4px;font-size:13px;opacity:.95;text-shadow:0 1px 2px rgba(0,0,0,.6)}

    .timer,.status{
      margin-top:10px;font-size:12.5px;display:flex;justify-content:space-between;opacity:.9;color:var(--muted)
    }
    .muted{opacity:.85;color:var(--muted)}
    .hidden{display:none}

    /* Kompaktmodus (showBars=0) */
    .compact .bar,.compact .pct{display:none}
    .compact .row{margin:6px 0}
    .compact .label{font-size:15px}
  </style>
</head>
<body>
  <div id="overlay" class="overlay scale">
    <div class="card">
      <div class="title"><span class="dot"></span><span id="title">Community Vote</span></div>
      <div id="poll">Warte auf Abstimmung…</div>
      <div class="timer">
        <span id="status" class="muted">Status: —</span>
        <span id="timer">Zeit übrig: 0s</span>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       URL-Parameter
       ========================= */
    const p = new URLSearchParams(location.search);
    const pos    = (p.get('pos')    || 'right').toLowerCase();
    const width  = parseInt(p.get('width') || '0',10);
    const scale  = parseFloat(p.get('scale') || '1');
    const title  = p.get('title');
    const demo   = p.get('demo') === '1';
    const showBars = (p.get('showBars') || '1') !== '0'; // 1=mit Balken, 0=ohne
    const themeFill = p.get('color'); // z.B. 8b5cf6
    const tChan  = p.get('twitchChannel'); // ohne #
    const tTok   = p.get('twitchToken');   // 'oauth:...'
    const opts   = (p.get('opts') || '').split('|').filter(Boolean);
    const secs   = parseInt(p.get('secs') || '30',10);

    const rootOverlay = document.getElementById('overlay');
    if (pos === 'left') rootOverlay.classList.add('left');
    rootOverlay.style.transform = `scale(${isNaN(scale)?1:scale})`;
    if (width) document.documentElement.style.setProperty('--width', `${width}px`);
    if (title) document.getElementById('title').textContent = title;
    if (!showBars) document.body.classList.add('compact');
    if (themeFill) {
      const hex = themeFill.replace('#','');
      document.documentElement.style.setProperty('--bar-fill', `#${hex}`);
      document.documentElement.style.setProperty('--bar-fill-2', `#${hex}`);
    }

    /* =========================
       Render
       ========================= */
    function render(data){
      const root = document.getElementById('poll');
      const timerEl = document.getElementById('timer');
      const total = (data.counts || []).reduce((a,b)=>a+b,0) || 1;
      let html = '';

      (data.options || []).forEach((opt, i) => {
        const cnt = data.counts[i] || 0;
        const pct = Math.round(cnt/total*100);
        html += `
          <div class="row">
            <div class="label">
              <span class="name">${i+1}. ${escapeHtml(opt)}</span>
              <span class="count">${cnt}${showBars? '' : '  Stimmen'}</span>
            </div>
            <div class="bar">
              <div class="fill" style="width:${pct}%"></div>
              <div class="pct${showBars? '' : ' hidden'}">${pct}%</div>
            </div>
          </div>`;
      });

      root.innerHTML = html || '<div>Warte auf Abstimmung…</div>';
      timerEl.textContent = `Zeit übrig: ${Math.max(0, data.secondsLeft|0)}s`;
    }

    function escapeHtml(s){
      return (s||'').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    }

    /* =========================
       Datenquellen: Demo / Twitch
       ========================= */
    const statusEl = document.getElementById('status');

    function demoMode(){
      let data = { options: opts.length?opts:['Creeper','Diamonds','Night'], counts: new Array(opts.length||3).fill(0), secondsLeft: secs };
      render(data);
      statusEl.textContent = 'Demo-Modus aktiv';
      const t = setInterval(()=>{
        data.secondsLeft = Math.max(0, data.secondsLeft-1);
        const i = Math.floor(Math.random()*data.counts.length);
        data.counts[i] += 1 + Math.floor(Math.random()*2);
        render(data);
        if (data.secondsLeft <= 0) clearInterval(t);
      },1000);
    }

    if (demo){
      demoMode();
    } else if (tChan && tTok){
      startTwitch(tChan, tTok);
    } else {
      statusEl.textContent = 'Status: Warte auf Parameter (twitchChannel, twitchToken oder demo=1)';
    }

    /* =========================
       Twitch IRC per WebSocket
       ========================= */
    function startTwitch(channel, token){
      try{
        const ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
        const preset = opts.length ? opts : ['Option 1','Option 2','Option 3'];
        let state = { options: preset, counts: new Array(preset.length).fill(0), secondsLeft: secs };
        render(state);

        ws.onopen = () => {
          const nick = 'overlay_'+Math.random().toString(36).slice(2,8);
          const tok = decodeURIComponent(token).startsWith('oauth:') ? decodeURIComponent(token) : ('oauth:'+decodeURIComponent(token));
          ws.send('PASS ' + tok);
          ws.send('NICK ' + nick);
          ws.send('JOIN #' + channel.toLowerCase());
          statusEl.textContent = `Verbunden: #${channel.toLowerCase()}`;
          const timer = setInterval(()=>{
            state.secondsLeft = Math.max(0, state.secondsLeft-1);
            render(state);
            if (state.secondsLeft <= 0) clearInterval(timer);
          },1000);
        };

        ws.onmessage = (ev) => {
          const lines = ev.data.split(/\r?\n/).filter(Boolean);
          for (const line of lines){
            if (line.startsWith('PING')) { ws.send('PONG :tmi.twitch.tv'); continue; }
            const m = line.match(/PRIVMSG\s+#([^\s]+)\s:([^\r\n]+)/);
            if (!m) continue;
            const msg = m[2].trim();
            // Chatnachricht: 1
            const r = msg.match(/^!?([1-9])(\b|$)/);
            if (!r) continue;
            const idx = parseInt(r[1],10)-1;
            if (idx >= 0 && idx < state.counts.length){
              state.counts[idx] += 1;
              render(state);
            }
          }
        };

        ws.onerror = () => statusEl.textContent = 'Verbindungsfehler – prüfe Token/Netzwerk';
        ws.onclose  = () => statusEl.textContent = 'Verbindung geschlossen';
      }catch(e){
        statusEl.textContent = 'Fehler beim Verbinden zu Twitch';
      }
    }
  </script>
</body>
</html>
